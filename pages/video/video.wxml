<view class="container">
  <!-- æ’­æ”¾å™¨å®¹å™¨ -->
  <view class="player-container">
    <video 
      id="player" 
      src="{{playUrl}}" 
      controls 
      autoplay 
      bindtimeupdate="onTimeUpdate" 
      binderror="onVideoError"
      bindloadstart="onVideoLoadStart"
      bindloadeddata="onVideoLoadedData"
      class="player"
    ></video>
    
    <!-- å¼¹å¹•æ˜¾ç¤ºç»„ä»¶ -->
    <danmu-display
      danmus="{{danmus}}"
      current-time="{{currentTime}}"
      enabled="{{danmuEnabled}}"
      opacity="{{danmuOpacity}}"
      speed="{{danmuSpeed}}"
    ></danmu-display>
    
    <!-- å¼¹å¹•æ§åˆ¶åŒºåŸŸ -->
    <view class="danmu-controls">
      <!-- å¼¹å¹•å‘é€æŒ‰é’® -->
      <danmu-send
        video-id="{{vid}}"
        current-time="{{currentTime}}"
        socket-connected="{{socketOpen}}"
        token="{{token}}"
      ></danmu-send>
      
      <!-- å¼¹å¹•å¼€å…³ -->
      <view class="danmu-toggle" bindtap="toggleDanmu">
        <text class="iconfont {{danmuEnabled ? 'icon-danmu-on' : 'icon-danmu-off'}}"></text>
        <text class="toggle-text">{{danmuEnabled ? 'å…³å¼¹å¹•' : 'å¼€å¼¹å¹•'}}</text>
      </view>
      
      <!-- è¿æ¥çŠ¶æ€å’Œé‡è¿æŒ‰é’® -->
      <view wx:if="{{!socketOpen}}" class="danmu-reconnect" bindtap="reconnectDanmu">
        <text class="iconfont icon-refresh"></text>
        <text class="reconnect-text">é‡è¿</text>
      </view>
    </view>
    
    <!-- å¼¹å¹•è¿æ¥çŠ¶æ€æç¤º -->
    <view wx:if="{{!socketOpen}}" class="danmu-status-tip">
      <text class="status-text">å®æ—¶å¼¹å¹•è¿æ¥æœªå»ºç«‹</text>
      <text class="status-tip">å†å²å¼¹å¹•æ­£å¸¸æ˜¾ç¤ºï¼Œç‚¹å‡»å³ä¸Šè§’é‡è¿æŒ‰é’®è¿æ¥å®æ—¶å¼¹å¹•</text>
    </view>
    
    <!-- è§†é¢‘åŠ è½½é”™è¯¯æç¤º -->
    <view class="video-error-overlay" wx:if="{{videoLoadError}}">
      <view class="error-content">
        <text class="error-icon">âš ï¸</text>
        <text class="error-text">è§†é¢‘åŠ è½½å¤±è´¥</text>
        <text class="error-tip">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</text>
        <button class="retry-btn" bindtap="retryVideo">é‡æ–°åŠ è½½</button>
      </view>
    </view>
  </view>

  <!-- æ ‡é¢˜ä¸åŸºç¡€ä¿¡æ¯ -->
  <view class="card v-info">
    <view class="v-title">{{video.video.title}}</view>
    <view class="v-meta">
      <text class="m">{{video.video.category || 'è§†é¢‘'}}</text>
      <text class="dot">Â·</text>
      <text class="m">{{formatNum(video.stats.play)}} æ¬¡è§‚çœ‹</text>
      <text class="dot">Â·</text>
      <text class="m">å¼¹å¹• {{formatNum(video.stats.danmu)}}</text>
      <text wx:if="{{danmus.length > 0}}" class="dot">Â·</text>
      <text wx:if="{{danmus.length > 0}}" class="m danmu-count">å·²åŠ è½½{{danmus.length}}æ¡</text>
    </view>
  </view>

  <!-- UP ä¸»ä¿¡æ¯åŒº -->
  <view class="card up" wx:if="{{uploader}}" bindtap="goAuthor" data-uid="{{uploader.uid}}">
    <view class="left">
      <image wx:if="{{uploader.avatar}}" class="up-avatar" src="{{uploader.avatar}}" mode="aspectFill" />
      <view wx:else class="up-avatar placeholder">ğŸ™‚</view>
      <view class="up-info">
        <view class="up-name text-ellipsis">{{uploader.name || 'UPä¸»'}}</view>
        <view class="up-desc text-ellipsis" wx:if="{{uploader.desc}}">{{uploader.desc}}</view>
      </view>
    </view>
    <view class="right">
      <view class="btn follow">+ å…³æ³¨</view>
    </view>
  </view>

  <!-- äº’åŠ¨æ“ä½œåŒº -->
  <view class="card actions">
    <!-- ç‚¹èµç»„ä»¶ -->
    <like-button
      video-id="{{vid}}"
      is-liked="{{video.isLiked || false}}"
      is-disliked="{{video.isDisliked || false}}"
      like-count="{{video.stats.good || 0}}"
      dislike-count="{{video.stats.bad || 0}}"
      bind:likechange="onLikeChange"
    ></like-button>
    
    <view class="act">
      <text class="iconfont icon-toubi"></text>
      <text class="txt">æŠ•å¸</text>
    </view>
    <!-- æ”¶è—ç»„ä»¶ -->
    <favorite-button
      video-id="{{vid}}"
      is-collected="{{video.isCollected || false}}"
      collect-count="{{video.stats.collect || 0}}"
      bind:favoritechange="onFavoriteChange"
    ></favorite-button>
    <view class="act">
      <text class="iconfont icon-zhuanfa"></text>
      <text class="txt">åˆ†äº«</text>
    </view>
  </view>



  <!-- ç›¸å…³æ¨è -->
  <view class="card related">
    <view class="section-title">ç›¸å…³æ¨è</view>
    <view class="r-list">
      <block wx:for="{{related}}" wx:key="vid">
        <view class="r-item" bindtap="goDetail" data-vid="{{item.video.vid}}">
          <image class="r-cover" src="{{item.video.cover_url || item.video.coverUrl}}" mode="aspectFill" />
          <view class="r-title text-ellipsis">{{item.video.title}}</view>
          <view class="r-meta">{{formatNum(item.stats.play)}} Â· {{formatNum(item.stats.danmu)}}å¼¹å¹•</view>
        </view>
      </block>
    </view>
  </view>
</view>

